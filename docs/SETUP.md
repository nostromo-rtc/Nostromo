- [Установка](#установка)
    - [Если вы хотите запустить релизную версию (из бинарников)](#если-вы-хотите-запустить-релизную-версию-из-бинарников)
    - [Если вы хотите запустить dev версию (из исходников)](#если-вы-хотите-запустить-dev-версию-из-исходников)
- [Настройки](#настройки)
    - [Гайд по быстрой настройке](#гайд-по-быстрой-настройке)
- [Требования](#требования)
    - [Требования для запуска программы](#требования-для-запуска-программы)
    - [Требования для сборки проекта](#требования-для-сборки-проекта)
    - [Требования для компиляции C/C++ компонентов](#требования-для-компиляции-cc-компонентов)
- [Трюки](#трюки)

# Установка

## Если вы хотите запустить релизную версию (из бинарников)

> Убедитесь, что вы установили **ВСЕ** [необходимые программы и зависимости](#требования-для-запуска-программы), необходимые для запуска программы.

1. Скачайте релиз и распакуйте архив.
2. Откройте директорию с программой в терминале.

> Не забудьте, что перед запуском необходимо изменить [настройки](#настройки).

3. Запустите программу.

```
$ npm start
```

## Если вы хотите запустить dev версию (из исходников)

В данном случае вам придется **собрать** проект.

**Сборка** состоит из двух этапов:
1. Сборка `C/C++` компонентов.
2. Сборка `npm` компонентов.

Чтобы **собрать** проект, следуйте инструкции:
1. Склонируйте репозиторий (скачав архив с сайта или с помощью Git).
```
$ git clone https://gitlab.com/sgakerru/nostromo.git
```
2. Откройте директорию с программой в терминале.

> Убедитесь, что вы установили **ВСЕ** [необходимые программы и зависимости](#требования-для-сборки-проекта), необходимые для сборки проекта.

> Если вы не хотите компилировать `C++` компоненты, такие как `mediasoup`, то есть пропустить первый этап, то вы можете попробовать скопировать папку `node_modules/mediasoup` из релизной версии, перед выполнением следующей команды.

> Для того, чтобы компонент `mediasoup` пропустил этап компиляции, можно установить параметр окружения `MEDIASOUP_WORKER_BIN`, и указать в качестве значения этой переменной путь до скомпилированного бинарного файла `mediasoup-worker.exe`
(Например: "C:\nostromo\node_modules\mediasoup\worker\out\Release\mediasoup-worker.exe"). Для Linux данный параметр работает аналогичным образом.

3. Теперь, когда все требования были удовлетворены, установите все `npm` пакеты (необходимые и для запуска, и для сборки проекта).
```
$ npm install
```


4. Запустите программу.

> Не забудьте, что перед запуском необходимо изменить [настройки](#настройки).

```
$ npm start
```

Если вы внесли изменения в `.ts` файлы из папки `src` и хотите пересобрать проект, используйте команду:
```
npm run build
```

# Настройки

> Подготовьте файл "`server.conf`".

Изначально в папке `"config/"` лежит файл `"server.default.conf"` - **конфигурация по умолчанию**.

Чтобы изменить настройки, скопируйте файл с конфигурацией по умолчанию, переименуйте в `"server.conf"` и внесите необходимые изменения.

Программа будет искать настройки в файле `"server.conf"`, а в случае, если этого файла не существует - в файле `"server.default.conf"`.

Если отсутствуют и `"server.conf"` и `"server.default.conf"`, то программа сообщит о соответствующей ошибке.

## Гайд по быстрой настройке
1. Скопируйте файл `"server.default.conf"` и назовите его `"server.conf"`. Откройте этот файл с конфигурацией.

2. Измените порты веб-сервера в случае необходимости (параметры `HTTP_PORT` и `HTTPS_PORT`).
    > Не забудьте открыть эти порты.

3. Укажите локальный и внешний IP-адрес сервера в параметрах `MEDIASOUP_LOCAL_IP` и `MEDIASOUP_ANNOUNCED_IP` для работы медиасервера.
    > Если планируется работа в локальной сети, то в `MEDIASOUP_ANNOUNCED_IP` можно ничего не писать.

4. Укажите диапазон портов для медиасервера от `MEDIASOUP_RTC_MIN_PORT` до `MEDIASOUP_RTC_MAX_PORT`.
    > Не забудьте открыть эти порты (желательно и **TCP** и **UDP** протокол, так как по умолчанию сервер поддерживает оба протокола связи с пользователем для передачи медиаданных).

5. Укажите входящую и исходящую скорость сети сервера (в мегабитах) для сбалансированного расчета битрейта медиапотоков для вашей сети: `NETWORK_INCOMING_CAPABILITY` - входящая скорость, `NETWORK_OUTCOMING_CAPABILITY` - исходящая скорость.

6. Измените пароль администратора. Доступ к админской панели доступен по адресу (`https://*адрес сайта*/admin`).

7. Измените секретные фразы, соли и прочее на свои (параметры `ROOM_PASS_HASH_SALT`, `TOKEN_SECRET_KEY`)

8. Положите ваши SSL сертификат и ключ в папку `"config/ssl"`.

    > Чтобы сгенерировать `самоподписный` SSL сертификат используйте команду (должен быть установлен `OpenSSL`):
    ```
    openssl req -newkey rsa:2048 -nodes -keyout private.key -new -x509 -days 365 -out public.crt
    ```

9. Запустите сервер, зайдите в панель администратора и создайте комнату.

# Требования

## Требования для запуска программы
Данное требование обязательно, поскольку необходимо для запуска:
>`Node.js LTS` (тестировалось на v12.22.11).

>`npm 8` (тестировалось на 8.5.5).

### Windows (тестировалось на Win10-v21H2)
> `Microsoft Visual C++ 2015-2022 Redist`.

## Требования для сборки проекта
Если вы решили собрать проект из исходников, должна быть установлена программа (пакет):
>`Git` (тестировалось на версии 2.35.1).

## Требования для компиляции C/C++ компонентов
Для того, чтобы [скомпилировать](https://mediasoup.org/documentation/v3/mediasoup/installation/) C/C++ компоненты библиотеки `mediasoup` должны быть установлены следующие программы (пакеты):

### Windows (тестировалось на Win10-v21H2)
* python версии >= 3.6 с PIP (тестировалось на 3.10.2)
    * Необходимо в настройках системы `Управление псевдонимами выполнения приложения` отключить все галки, связанные с Python.
* Visual C++ Build Environment with C++11 support (тестировалось на VS Build Tools 2019 - 16.11.9)
    * Пакет - `разработка классических приложений на C++`.
* make
    * GNU make необходимо установить из MSYS из пакета [MinGW](https://sourceforge.net/projects/mingw/). Убедитесь, что путь до папки с бинарным файлом `make` прописан в параметре окружения `PATH` (например C:\MinGW\msys\1.0\bin).

### Linux (тестировалось на Debian 11 Bullseye)
* python версии >= 3.6 с PIP (тестировалось на 3.9.2-3)
* make
* gcc и g++ >= 4.9 или clang (с поддержкой C++11) (тестировалось на gcc 10.2.1-1)
* команды (symlinks) cc и c++ указывающие на соответствущие исполняемые файлы gcc/g++ или clang/clang++.

> В `Debian` и `Ubuntu` установите `build-essential` .deb пакет. Он включает в себя и make и gcc/g++.
> В `Debian` и `Ubuntu` установите `python3-pip` .deb пакет, иначе пакетный менеджер PIP может быть недоступен.

* `Перебросьте порты` для Http и Https сервера на порты больше чем 1024.
    * Вы можете поменять `порт приложения` в файле `server.conf`.
    * Непривелигированные пользователи (не root) не могут открыть сокет на порте ниже чем 1024.

> Для примера на `Debian`:
```
sudo iptables -A PREROUTING -t nat -p tcp --dport 80 -j REDIRECT --to-port 5000
sudo iptables -A PREROUTING -t nat -p tcp --dport 443 -j REDIRECT --to-port 5001
```

# Трюки

## Windows

После компиляции `mediasoup`, исполняемый файл `mediasoup-worker.exe` при запуске создает процесс `conhost.exe` (каждый потребляет по 5 Мб) соответственно при создании четырёх `Mediasoup.Worker` создадутся и четыре `conhost.exe`. `conhost.exe` нужен для drag-n-drop в консоли и оформления (темы), но поскольку процесс `worker` фоновый, ему это ни к чему.
Поэтому есть трюк, как отключить `conhost.exe`. Для этого нужно изменить у `mediasoup-worker.exe` тип с консольного приложения на обычное.
> Это можно сделать с помощью утилиты `binedit.exe`, которая входит в состав `Visual C++ Build Environment`:
```bat
"path to editbin.exe" /SUBSYSTEM:WINDOWS "path to mediasoup-worker.exe"
```

> И пример:
```bat
"C:\Program Files (x86)\Microsoft Visual Studio\2019\BuildTools\VC\Tools\MSVC\14.29.30037\bin\Hostx64\x64\editbin.exe" /SUBSYSTEM:WINDOWS "C:\nostromo\node_modules\mediasoup\worker\out\Release\mediasoup-worker.exe"
```